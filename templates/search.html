{% extends "base.html" %}

{% block title %}Search Jobs - AI Internship Finder{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0"><i class="fas fa-search"></i> Advanced Job Search</h1>
        <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Back to Dashboard
        </a>
    </div>

    <!-- Search Form -->
    <div class="card shadow mb-4">
        <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-filter"></i> Search Filters</h5>
        </div>
        <div class="card-body">
            <form id="searchForm">
                <div class="row">
                    <!-- Text Search -->
                    <div class="col-md-6 mb-3">
                        <label for="searchText" class="form-label">Search Text</label>
                        <input type="text" class="form-control" id="searchText" name="search_text" 
                               placeholder="Job title, company, keywords...">
                        <small class="form-text text-muted">Search in job titles, companies, and descriptions</small>
                    </div>

                    <!-- Company Filter -->
                    <div class="col-md-6 mb-3">
                        <label for="company" class="form-label">Company</label>
                        <input type="text" class="form-control" id="company" name="company" 
                               placeholder="Company name">
                    </div>

                    <!-- Location Filter -->
                    <div class="col-md-6 mb-3">
                        <label for="location" class="form-label">Location</label>
                        <input type="text" class="form-control" id="location" name="location" 
                               placeholder="City, State, Remote...">
                    </div>

                    <!-- Job Type Filter -->
                    <div class="col-md-6 mb-3">
                        <label for="jobType" class="form-label">Job Type</label>
                        <select class="form-control" id="jobType" name="job_type">
                            <option value="">All Types</option>
                            <option value="Full-time">Full-time</option>
                            <option value="Part-time">Part-time</option>
                            <option value="Internship">Internship</option>
                            <option value="Contract">Contract</option>
                            <option value="Temporary">Temporary</option>
                            <option value="Remote">Remote</option>
                        </select>
                    </div>

                    <!-- Status Filter -->
                    <div class="col-md-6 mb-3">
                        <label for="status" class="form-label">Application Status</label>
                        <select class="form-control" id="status" name="status">
                            <option value="">All Statuses</option>
                            <option value="new">New</option>
                            <option value="interested">Interested</option>
                            <option value="applied">Applied</option>
                            <option value="interview">Interview</option>
                            <option value="rejected">Rejected</option>
                            <option value="not_interested">Not Interested</option>
                            <option value="hidden">Hidden</option>
                        </select>
                    </div>

                    <!-- Date Range -->
                    <div class="col-md-6 mb-3">
                        <label for="dateRange" class="form-label">Discovered Date</label>
                        <select class="form-control" id="dateRange" name="date_range">
                            <option value="">All Time</option>
                            <option value="today">Today</option>
                            <option value="week">This Week</option>
                            <option value="month">This Month</option>
                            <option value="quarter">Last 3 Months</option>
                        </select>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="row">
                    <div class="col-12">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-search"></i> Search Jobs
                        </button>
                        <button type="button" class="btn btn-secondary ml-2" onclick="clearSearch()">
                            <i class="fas fa-times"></i> Clear
                        </button>
                        <button type="button" class="btn btn-info ml-2" onclick="exportResults()">
                            <i class="fas fa-download"></i> Export Results
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Search Results -->
    <div class="card shadow">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-list"></i> Search Results</h5>
            <div class="search-stats">
                <span id="resultCount" class="badge badge-primary">0 results</span>
            </div>
        </div>
        <div class="card-body">
            <!-- Loading indicator -->
            <div id="loadingIndicator" class="text-center py-4" style="display: none;">
                <div class="spinner-border text-primary" role="status">
                    <span class="sr-only">Searching...</span>
                </div>
                <p class="mt-2">Searching jobs...</p>
            </div>

            <!-- Results container -->
            <div id="searchResults">
                <div class="text-center py-5">
                    <i class="fas fa-search fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">Enter search criteria and click "Search Jobs" to find opportunities</h5>
                    <p class="text-muted">Use the filters above to narrow down your search</p>
                </div>
            </div>

            <!-- Pagination -->
            <nav id="pagination" style="display: none;">
                <ul class="pagination justify-content-center">
                    <!-- Pagination will be dynamically generated -->
                </ul>
            </nav>
        </div>
    </div>
</div>

<script>
let currentPage = 1;
let totalPages = 1;

// Form submission handler
document.getElementById('searchForm').addEventListener('submit', function(e) {
    e.preventDefault();
    performSearch(1);
});

// Perform search function
function performSearch(page = 1) {
    const formData = new FormData(document.getElementById('searchForm'));
    const params = new URLSearchParams();
    
    // Add form data to params
    for (let [key, value] of formData.entries()) {
        if (value.trim()) {
            params.append(key, value);
        }
    }
    
    params.append('page', page);
    
    // Show loading indicator
    document.getElementById('loadingIndicator').style.display = 'block';
    document.getElementById('searchResults').innerHTML = '';
    
    // Make search request
    fetch('/api/search?' + params.toString())
        .then(response => response.json())
        .then(data => {
            displayResults(data);
            currentPage = page;
            totalPages = Math.ceil(data.total / data.per_page);
            updatePagination();
        })
        .catch(error => {
            console.error('Search error:', error);
            document.getElementById('searchResults').innerHTML = 
                '<div class="alert alert-danger">Error performing search. Please try again.</div>';
        })
        .finally(() => {
            document.getElementById('loadingIndicator').style.display = 'none';
        });
}

// Display search results
function displayResults(data) {
    const resultsContainer = document.getElementById('searchResults');
    const resultCount = document.getElementById('resultCount');
    
    resultCount.textContent = `${data.total} result${data.total !== 1 ? 's' : ''}`;
    
    if (data.jobs.length === 0) {
        resultsContainer.innerHTML = `
            <div class="text-center py-5">
                <i class="fas fa-search-minus fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">No jobs found</h5>
                <p class="text-muted">Try adjusting your search criteria</p>
            </div>
        `;
        return;
    }
    
    let html = '<div class="list-group list-group-flush">';
    
    data.jobs.forEach(job => {
        const statusBadge = getStatusBadge(job.status);
        const excerpt = job.description ? 
            job.description.substring(0, 150) + (job.description.length > 150 ? '...' : '') : 
            'No description available';
        
        html += `
            <div class="list-group-item list-group-item-action">
                <div class="d-flex w-100 justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <h6 class="mb-1">
                            <a href="/job/${job.job_id}" class="text-decoration-none">
                                ${job.job_title || 'Unknown Position'}
                            </a>
                        </h6>
                        <p class="mb-1 text-muted">
                            <i class="fas fa-building"></i> ${job.company || 'Unknown Company'}
                            ${job.location ? `<i class="fas fa-map-marker-alt ml-3"></i> ${job.location}` : ''}
                            ${job.job_type ? `<i class="fas fa-briefcase ml-3"></i> ${job.job_type}` : ''}
                        </p>
                        <p class="mb-2 text-muted small">${excerpt}</p>
                        <small class="text-muted">
                            Discovered: ${job.extracted_at ? new Date(job.extracted_at).toLocaleDateString() : 'Unknown'}
                        </small>
                    </div>
                    <div class="ml-3">
                        ${statusBadge}
                    </div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    resultsContainer.innerHTML = html;
}

// Get status badge HTML
function getStatusBadge(status) {
    const badges = {
        'new': 'badge-secondary',
        'interested': 'badge-warning',
        'applied': 'badge-success',
        'interview': 'badge-info',
        'rejected': 'badge-danger',
        'not_interested': 'badge-dark',
        'hidden': 'badge-light'
    };
    
    const badgeClass = badges[status] || 'badge-secondary';
    const statusText = status ? status.replace('_', ' ').toUpperCase() : 'NEW';
    
    return `<span class="badge ${badgeClass}">${statusText}</span>`;
}

// Update pagination
function updatePagination() {
    const pagination = document.getElementById('pagination');
    const paginationList = pagination.querySelector('.pagination');
    
    if (totalPages <= 1) {
        pagination.style.display = 'none';
        return;
    }
    
    pagination.style.display = 'block';
    
    let html = '';
    
    // Previous button
    html += `
        <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="performSearch(${currentPage - 1})" 
               ${currentPage === 1 ? 'tabindex="-1"' : ''}>Previous</a>
        </li>
    `;
    
    // Page numbers
    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, currentPage + 2);
    
    if (startPage > 1) {
        html += '<li class="page-item"><a class="page-link" href="#" onclick="performSearch(1)">1</a></li>';
        if (startPage > 2) {
            html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
        }
    }
    
    for (let i = startPage; i <= endPage; i++) {
        html += `
            <li class="page-item ${i === currentPage ? 'active' : ''}">
                <a class="page-link" href="#" onclick="performSearch(${i})">${i}</a>
            </li>
        `;
    }
    
    if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
            html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
        }
        html += `<li class="page-item"><a class="page-link" href="#" onclick="performSearch(${totalPages})">${totalPages}</a></li>`;
    }
    
    // Next button
    html += `
        <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="performSearch(${currentPage + 1})"
               ${currentPage === totalPages ? 'tabindex="-1"' : ''}>Next</a>
        </li>
    `;
    
    paginationList.innerHTML = html;
}

// Clear search form
function clearSearch() {
    document.getElementById('searchForm').reset();
    document.getElementById('searchResults').innerHTML = `
        <div class="text-center py-5">
            <i class="fas fa-search fa-3x text-muted mb-3"></i>
            <h5 class="text-muted">Enter search criteria and click "Search Jobs" to find opportunities</h5>
            <p class="text-muted">Use the filters above to narrow down your search</p>
        </div>
    `;
    document.getElementById('resultCount').textContent = '0 results';
    document.getElementById('pagination').style.display = 'none';
}

// Export search results
function exportResults() {
    const formData = new FormData(document.getElementById('searchForm'));
    const params = new URLSearchParams();
    
    for (let [key, value] of formData.entries()) {
        if (value.trim()) {
            params.append(key, value);
        }
    }
    
    params.append('export', 'csv');
    
    // Create download link
    const url = '/api/search?' + params.toString();
    const link = document.createElement('a');
    link.href = url;
    link.download = 'job_search_results.csv';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}
</script>

<style>
.card {
    border: none;
    border-radius: 10px;
}

.list-group-item {
    border-left: none;
    border-right: none;
}

.list-group-item:first-child {
    border-top: none;
}

.list-group-item:last-child {
    border-bottom: none;
}

.badge {
    font-size: 0.75rem;
}

.spinner-border {
    width: 2rem;
    height: 2rem;
}

.page-link {
    color: #007bff;
}

.page-item.active .page-link {
    background-color: #007bff;
    border-color: #007bff;
}
</style>
{% endblock %} 